<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-route-converter.html">

<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-menu/paper-menu.html">

<link rel="import" href="../uvalib-helper-libs/lodash.html">
<link rel="import" href="../uvalib-helper-libs/uvalib-html-echo.html">

<link rel="import" href="../uvalib-helper-libs/uvalib-helper-behaviors.html">
<link rel="import" href="../uva-brand-style/uva-layout-behavior.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">

<dom-module id="uvalib-newsletter-pages">

<template>
  <style is="custom-style" include="uvalib-theme">

  :host {
    display: block;
    height: auto;
  }

  #articlemenu h2 {
    margin: 0;
    color: #E57200;
    font-size: 1.6em;
    margin-bottom: .5em;
  }

  #articlemenu a:link, #articlemenu a:visited, #articlemenu a:hover, #articlemenu a:active {
    color: #E57200
  }

  #articlemenu .select-item {
    padding: 15px;
  }

  #articlemenu .iron-selected {
    font-weight: inherit;
    background-color: #E57200;
    color: #ffffff;
  }

  #articlemenu .iron-selected h2 {
    color: #ffffff;
  }

  #articlemenu {
    float:right;
    width: 300px;
    margin: 20px;
  }

  #content hr {
    border-top: dotted 2px;
    border-top-color: #002359;
    width: 100%;
  }

  #content {
    margin-top: 2.5em;
    line-height:2;
  }

  paper-menu#articlemenu {
    padding: 0;
  }

  .wp-content {
    --html-echo-first-letter: {
      float: left;
      font-size: 75px;
      line-height: 60px;
      padding-top: 4px;
      padding-right: 8px;
      padding-left: 3px;
      font-family: font-family: "prenton", "Helvetica Neue", Arial, sans-serif;
    };
  }
  </style>

  <app-route route="{{route}}" pattern="/:issue" data="{{_issueData}}" tail="{{_articleRoute}}" active="{{_isIssue}}"></app-route>
  <app-route route="{{_articleRoute}}" pattern="/:article" data="{{_articleData}}" active="{{_isArticle}}"></app-route>
  <app-route route="{{route}}" pattern="/" active="{{_initActive}}"></app-route>

  <iron-media-query query="{{smallScreenQuery}}" query-matches="{{smallScreen}}"></iron-media-query>
  <iron-media-query query="{{mediumScreenQuery}}" query-matches="{{mediumScreen}}"></iron-media-query>
  <iron-media-query query="{{largeScreenQuery}}" query-matches="{{largeScreen}}"></iron-media-query>

  <div id="content" class$="{{_issmallclass(smallScreen)}}">

    <paper-menu id="articlemenu" attr-for-selected="id" selected="{{_selectedArticleSlug}}">
      <template is="dom-repeat" items="{{_articles}}">
        <div class="select-item" id="{{item.slug}}">
          <h2><uvalib-html-echo html="{{item.title}}"></uvalib-html-echo></h2>
          <uvalib-html-echo html="{{item.excerpt}}"></uvalib-html-echo>
          <div class="more"><a href="{{item.slug}}">read more</a></div>
        </div>
      </template>
    </paper-menu>

    <article id="article" hidden$="{{!selectedArticle}}">
        <uvalib-html-echo html="{{selectedArticle.title}}"></uvalib-html-echo>
        <uvalib-html-echo class="wp-content" html="{{selectedArticle.content}}"></uvalib-html-echo>
    </article>

    <article id="issue" hidden$="{{selectedArticle}}">
      <uvalib-html-echo class="wp-content" html="{{selectedIssue.content}}"></uvalib-html-echo>
    </article>

  </div>

</template>

<script>

Polymer({
  is: 'uvalib-newsletter-pages',
  behaviors: [uvabehaviors.layout,uvalibbehaviors.helpers],
  properties: {
    rootPath: String,
    articles: {
      type:Object,
      value:{},
      observer:"_init"
    },
    route: {
      type: Object,
      notify: true,
    },
    _initActive: {
      type: Boolean,
      observer: '_init'
    },
    _data: {
      type: Object
    },
    selectedArticle: {
      type: Object,
      value: null,
      notify: true
    },
    selectedIssue: {
      type: Object,
      value: null,
      notify: true
    },
    _issues: {
      type: Array,
      value: []
    },
    _articles: {
      type: Array,
      value: []
    },
    _selectedArticleSlug: {
      type: String,
      observer: '_changeArticle'
    }
  },

  observers: ['_init(_issueData.issue, _articleData.article, _initActive, articles)',
              '_parseIssuesArticles(articles)',
              '_selectArticle(_articleData.article)',
              '_selectIssue(_issueData.issue)'],
  _init: function(){
    this.debounce('init', function(){
      console.log('init');
      if (!this.route.path )
        this.set('route.path', '/');
      if (!this._issueData.issue) {
        var latestIssue = this._latestIssue();
        if (latestIssue) this.set('_issueData.issue', latestIssue.slug);
      }
      if ( !this._isArticle && !_.endsWith(this.route.path,'/') )
        this.set('route.path', this.route.path+'/');
    }, 100);
  },

  _latestIssue: function(){
    return _.head(this._issues);
  },

  _issmallclass: function(small){
    if (small) return "small-screen";
  },

  _parseIssuesArticles: function(articles){
    this._issues = [];
    this._articles = [];
    var posts = _.orderBy(this.articles.posts, ['date'], ['desc'])
    .forEach(function(post){
      if (post.children.length>0) this.push('_issues',post);
      else this.push('_articles',post);
    }.bind(this));
  },

  _selectIssue: function(issue){
    this.selectedIssue = _.find(this._issues,['slug',issue]);
  },

  _selectArticle: function(article){
    this.selectedArticle = _.find(this._articles,['slug',article]);
  },

  _changeArticle: function(){
    this.set('_articleData.article', this._selectedArticleSlug)
  }
});
</script>

</dom-module>
