<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-route-converter.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../uvalib-page/uvalib-alt-page.html">
<link rel="import" href="../uvalib-card/uvalib-alt-card.html">
<link rel="import" href="../uvalib-button/uvalib-button.html">
<link rel="import" href="../uvalib-helper-libs/uvalib-helper-behaviors.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="uvalib-newsletter-pages.html">

<link rel="import" href="../uvalib-logos/uvalib-logo.html">
<link rel="import" href="../uva-footer/uva-footer.html">

<link rel="import" href="lodash.html">

<dom-module id="uvalib-staff-newsletter">

<template>
  <style is="custom-style" include="uvalib-theme">
  :host {
    display: block;
  }
  #cardContainer {
    @apply(--layout-horizontal);
    @apply(--layout-wrap);
  }
  uvalib-card {
    @apply(--layout-flex);
    margin: 20px;
    min-width: 400px;
    --paper-card-header-image: {
      height: 100%;
    };
  }
  hr {
    border-top: dotted 2px;
    border-top-color: var(--color-primary-blue);
    width: 100%;
  }

  .card-header {
    padding-left: 15px;
  }
  .card-content {}
  .card-actions {}


  uva-footer {
    background-color: var(--color-primary-orange);
  }
  </style>

  <app-location route="{{_route}}"></app-location>
  <app-route route="{{_route}}" pattern="{{rootPath}}news" tail="{{_newsRoute}}" active="{{_newsActive}}"></app-route>
  <app-route route="{{_route}}" pattern="{{rootPath}}hoo" tail="{{_hooRoute}}" active="{{_hooActive}}"></app-route>
  <app-route route="{{_route}}" pattern="{{rootPath}}" active="{{_initActive}}"></app-route>

  <iron-ajax url="{{rootPath}}api/get_recent_posts/?dev=1&count=0&post_type=uvalib_hierarchypost" auto last-response="{{news}}"></iron-ajax>
  <iron-ajax url="{{rootPath}}api/get_recent_posts/?dev=1&count=0&post_type=uvalib_guesshoo" auto last-response="{{trivia}}"></iron-ajax>

  <uvalib-alt-page root-path="{{rootPath}}" title="Staff News" sub-title="UVA Library Staff News &mdash; Fall 2016"
                  image="https://staffnews.staffweb.lib.virginia.edu/wp-content/uploads/sites/3/2016/11/header_image_rotunda.jpg">

    <div id="news" hidden$="{{!_newsActive}}">
      <uvalib-newsletter-pages name="news" items="{{news}}" path="{{_subPathNews}}" route="{{_newsRoute}}"
                    root-path="{{rootPath}}news"></uvalib-newsletter-pages>
    </div>

    <div id="hoo" hidden$="{{!_hooActive}}">
      <uvalib-newsletter-pages articles="{{_hooArticles}}" minimal-menu name="hoo" items="{{trivia}}" path="{{_subPathHoo}}" route="{{_hooRoute}}"
                    root-path="{{rootPath}}hoo" on-pushing-items="grabHoo"></uvalib-newsletter-pages>
    </div>

    <hr />

    <div id="cardContainer" hidden$="{{_hooActive}}">
      <template is="dom-repeat" items="{{_rand(_hooArticles)}}">
        <uvalib-card id="hoo" horizontal on-tap="_openlink" heading="Guess Hoo?"
            href="{{rootPath}}hoo/fall-issue/{{item.slug}}"
            image="https://staffnews.staffweb.lib.virginia.edu/wp-content/uploads/sites/3/2016/11/guesshoo.png">
            <div class="card-content" inner-h-t-m-l="{{item.excerpt}}"></div>
            <div class="card-actions">
              <uvalib-button href="{{rootPath}}hoo/fall-issue/{{item.slug}}">Find Out</uvalib-button>
            </div>
        </uvalib-card>
      </template>

      <uvalib-card id="comego" horizontal on-tap="_openlink" heading="Staff Arrivals/Departures"
          href="https://staffweb.lib.virginia.edu/open-positions-and-selections/"
          image="https://staffnews.staffweb.lib.virginia.edu/wp-content/uploads/sites/3/2016/11/arrivals_departures.png">
          <div class="card-content"><p>See who has been arriving and departing the Library</p></div>
          <div class="card-actions">
            <uvalib-button href="https://staffweb.lib.virginia.edu/open-positions-and-selections/">Read More</uvalib-button>
          </div>
      </uvalib-card>
    </div>

    <uva-footer class="lib" logo-override>
      <uvalib-logo text-only stacked reverse class="logo" style="width:100%; color:white;"></uvalib-logo>
    </uva-footer>

  </uvalib-alt-page>

</template>

<script>

Polymer({
  is: 'uvalib-staff-newsletter',
  behaviors: [uvalibbehaviors.helpers],
  properties: {
    rootPath: {
      type:String,
      value:'/'
    },
    news: Object,
    trivia: Object,
    _initActive: {
      type: Boolean,
      observer: '_init'
    },
    randomTrivia: {
      type: Object,
    },
    _route: {
      type: Object,
    },
    _count: {
      type: Number,
      value: 0
    },
    _hooArticles: {
      type: Array,
      value: null
    },
  },
  observers: ['_routeCount(_route.path)'],
  _init: function(){
    if (this._initActive)
      this.set('_route.path', this.rootPath+"news");
  },
  _rand: function(list){
    if(_.isArray(list))
      if (list.length>1) return [ list[_.random(list.length-1)] ]
      else if (list.length=1) return list;
      else return [];
    else return [];
  },
  ready: function() {
    this.async(function() {
      // If the path is blank, redirect to /
      if (!this._route.path) {
        this.set('_route.path', this.rootPath);
      }
    });
  },
  _resetScroll: function(){
    window.scroll(0,450);
  },
  _routeCount: function(){
    this.debounce('routecounter', function(){
      this._count = this._count+1;
      if (this._count > 2) this._resetScroll();
      console.log('youve been routed '+this._count+' times!')
    }.bind(this), 200);
  }

});

</script>

</dom-module>
